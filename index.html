<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FigBuild – Make your FigBadge</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #EFEFEF;
      --white: #FFFFFF;
      --black: #0D0D0D;
      --panel-bg: #F2F2F2;
      --border: #E0E0E0;
      --accent: #0D0D0D;
      --accent-hover: #333333;
      --muted: #888;
      --radius: 12px;
    }

    html, body {
      height: 100%;
      overflow: hidden;
    }

    body {
      font-family: 'Space Grotesk', sans-serif;
      background: var(--bg);
      color: var(--black);
      display: flex;
      flex-direction: column;
    }

    /* ── NAV ── */
    .nav {
      flex: 0 0 auto;
      padding: 24px 60px 16px;
    }
    .back-btn {
      background: none; border: none; cursor: pointer;
      font-family: inherit; font-size: 13px;
      color: var(--muted); display: flex; align-items: center; gap: 5px;
      transition: color 0.15s;
    }
    .back-btn:hover { color: var(--black); }

    /* ── ROOT LAYOUT: 3 columns, fills remaining height ── */
    .layout {
      flex: 1 1 0;
      min-height: 0;
      display: grid;
      grid-template-columns: 280px 320px 1fr;
      gap: 20px;
      padding: 0 60px 32px 60px;
      overflow: hidden;
    }

    /* ── SHARED COLUMN BASE ── */
    .left-col,
    .center-col,
    .right-col {
      display: flex;
      flex-direction: column;
      min-height: 0;
      overflow: hidden;
    }

    /* ── LEFT COLUMN ── */
    .left-col { gap: 16px; padding-top: 8px; }

    .headline {
      font-size: 36px;
      font-weight: 700;
      line-height: 1.05;
      letter-spacing: -1px;
      flex: 0 0 auto;
      margin-bottom: 8px;
    }

    /* Generic panel */
    .panel {
      background: var(--white);
      border-radius: var(--radius);
      padding: 16px 18px;
      border: 1.5px solid var(--border);
      flex: 0 0 auto;
    }

    .panel-title {
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 12px;
    }

    /* Border */
    .border-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
    }
    .border-opt {
      display: flex; flex-direction: column;
      align-items: center; gap: 6px; cursor: pointer;
    }
    .border-preview {
      width: 100%; aspect-ratio: 1; border-radius: 8px;
      background: var(--panel-bg);
      display: flex; align-items: center; justify-content: center;
      transition: all 0.15s;
    }
    .border-preview-inner { width: 70%; height: 70%; }
    .border-opt.active .border-preview,
    .border-preview:hover { outline: 2px solid var(--accent); outline-offset: 1px; }
    .border-label { font-size: 10px; color: var(--muted); font-weight: 500; }

    /* Cords */
    .cord-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }
    .cord-opt {
      display: flex; flex-direction: column;
      align-items: center; gap: 6px; cursor: pointer;
    }
    .cord-preview {
      width: 100%; aspect-ratio: 1;
      border-radius: 8px; background: var(--panel-bg);
      display: flex; align-items: center; justify-content: center;
      transition: all 0.15s; overflow: hidden;
    }
    .cord-opt.active .cord-preview,
    .cord-preview:hover { outline: 2px solid var(--accent); outline-offset: 1px; }
    .cord-shape { width: 30%; height: 70%; }
    .cord-label { font-size: 10px; color: var(--muted); font-weight: 500; }

    /* ── CENTER COLUMN ── */
    .center-col { gap: 16px; padding-top: 8px; }

    /* Draw */
    .draw-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }
    .stroke-opt {
      display: flex; flex-direction: column;
      align-items: center; gap: 6px; cursor: pointer;
    }
    .stroke-preview {
      width: 100%; aspect-ratio: 1;
      border-radius: 8px; background: var(--panel-bg);
      display: flex; align-items: center; justify-content: center;
      transition: all 0.15s;
    }
    .stroke-opt.active .stroke-preview,
    .stroke-preview:hover { outline: 2px solid var(--accent); outline-offset: 1px; }
    .stroke-dot { background: var(--black); border-radius: 50%; }
    .stroke-label { font-size: 10px; color: var(--muted); font-weight: 500; }

    /* Stickers — fixed height panel with 4 stickers only */
    .panel-stickers {
      background: var(--white);
      border-radius: var(--radius);
      padding: 16px 18px;
      border: 1.5px solid var(--border);
      flex: 0 0 auto;
    }

    .sticker-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
    }
    .sticker-item {
      aspect-ratio: 1; border-radius: 8px;
      background: var(--panel-bg);
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; transition: all 0.15s;
      border: 2px solid transparent;
    }
    .sticker-item:hover { 
      outline: 2px solid var(--accent); 
      outline-offset: 1px;
      transform: scale(1.02); 
    }
    .sticker-item.selected { 
      outline: 2px solid var(--accent); 
      outline-offset: 1px;
      background: rgba(13,13,13,0.04); 
    }

    /* Background */
    .bg-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
    }
    .bg-opt {
      display: flex; flex-direction: column;
      align-items: center; gap: 6px; cursor: pointer;
    }
    .bg-preview {
      width: 100%; aspect-ratio: 1;
      border-radius: 8px; overflow: hidden;
      border: 2px solid transparent; transition: all 0.15s;
      background: var(--panel-bg);
      display: flex; align-items: center; justify-content: center;
    }
    .bg-opt.active .bg-preview,
    .bg-preview:hover { outline: 2px solid var(--accent); outline-offset: 1px; }
    .bg-label { font-size: 10px; color: var(--muted); font-weight: 500; }

    .bg-preview-inner {
      width: 100%;
      height: 100%;
    }

    .pat-none    { background: #f8f8f8; }
    .pat-swag    { background: repeating-conic-gradient(#2E8B57 0% 25%,#1E6B3E 0% 50%) 0 0/10px 10px; }
    .pat-creative{ background: repeating-conic-gradient(#FF2D78 0% 25%,#D90057 0% 50%) 0 0/10px 10px; }
    .pat-playful { background: repeating-conic-gradient(#FFB700 0% 25%,#FF6B00 0% 50%) 0 0/10px 10px; }

    /* ── RIGHT COLUMN ── */
    .right-col {
      align-items: center;
      justify-content: center;
      gap: 20px;
      padding-top: 8px;
    }

    /* Badge assembly grows to fill, scale wrapper adjusts internally */
    .badge-assembly {
      display: flex;
      flex-direction: column;
      align-items: center;
      flex: 1 1 0;
      min-height: 0;
      width: 100%;
      justify-content: center;
      overflow: hidden;
    }

    .badge-scale-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      transform-origin: top center;
    }

    /* Strap */
    .lanyard-strap {
      width: 40px; height: 90px;
      border-radius: 4px 4px 0 0;
      display: flex; align-items: flex-start; justify-content: center;
      overflow: hidden; padding-top: 6px;
    }
    .strap-text {
      font-size: 7px; font-weight: 700; letter-spacing: 0.1em;
      writing-mode: vertical-lr; transform: rotate(180deg);
      color: rgba(255,255,255,0.5);
    }
    .strap-connector {
      width: 48px; height: 14px;
      background: #C8C8C8; border-radius: 3px;
      border: 1.5px solid #AAAAAA;
    }

    /* Badge card — fixed intrinsic size, scaled via JS */
    .badge-card {
      width: 340px; height: 480px;
      background: var(--white);
      border-radius: 10px;
      position: relative; overflow: hidden;
      box-shadow: 0 8px 32px rgba(0,0,0,0.13), 0 2px 6px rgba(0,0,0,0.06);
    }

    .badge-border-dashed { outline: 3px dashed var(--black); outline-offset: -5px; }
    .badge-border-solid  { outline: 3px solid  var(--black); outline-offset: -5px; }

    .badge-header {
      background: var(--black);
      padding: 10px 12px 9px;
      display: flex; align-items: center; gap: 8px;
    }
    .badge-logo-pill {
      background: var(--white); border-radius: 5px;
      padding: 4px 10px; font-size: 17px; font-weight: 700; letter-spacing: -0.3px;
    }
    .badge-year-pill {
      background: var(--black); border: 2px solid var(--white);
      border-radius: 999px; padding: 4px 12px;
      font-size: 17px; font-weight: 700; color: var(--white);
    }

    #drawCanvas {
      position: absolute; top: 0; left: 0;
      width: 100%; height: 100%;
      cursor: crosshair; touch-action: none;
    }
    #stickerLayer {
      position: absolute; top: 0; left: 0;
      width: 100%; height: 100%;
      pointer-events: none;
    }
    .badge-bg-fill {
      position: absolute; bottom: 0; left: 0; right: 0;
      height: 33%; pointer-events: none;
    }
    .badge-wiggly-border {
      position: absolute; top: 0; left: 0;
      width: 100%; height: 100%; pointer-events: none;
    }

    /* ── ACTIONS ── */
    .actions-row {
      display: flex; gap: 8px; align-items: center;
      flex: 0 0 auto;
    }
    .btn-secondary {
      padding: 9px 18px; border-radius: 8px;
      border: 1.5px solid var(--border); background: var(--white);
      font-family: inherit; font-size: 13px; font-weight: 600;
      cursor: pointer; transition: all 0.15s; color: var(--black);
    }
    .btn-secondary:hover { border-color: var(--black); }
    .btn-primary {
      padding: 9px 22px; border-radius: 8px; border: none;
      background: var(--accent); color: white;
      font-family: inherit; font-size: 13px; font-weight: 700;
      cursor: pointer; transition: all 0.15s;
    }
    .btn-primary:hover { background: var(--accent-hover); transform: translateY(-1px); }

    /* ── PLACED STICKER ── */
    .canvas-sticker {
      position: absolute; cursor: move;
      user-select: none; transform-origin: center;
      pointer-events: all;
    }
    .canvas-sticker:hover .sticker-delete { display: flex; }
    .sticker-delete {
      display: none; position: absolute;
      top: -7px; right: -7px;
      width: 16px; height: 16px;
      border-radius: 50%; background: #FF3B30;
      color: white; font-size: 9px;
      align-items: center; justify-content: center;
      cursor: pointer; pointer-events: all; z-index: 10;
    }

    body.placing-sticker #drawCanvas { cursor: copy; }
    body.placing-sticker .badge-card { outline: 2.5px dashed var(--accent); }
  </style>
</head>
<body>

<nav class="nav">
  <button class="back-btn">&#8592; Back</button>
</nav>

<div class="layout">

  <!-- ── LEFT COLUMN ── -->
  <div class="left-col">
    <h1 class="headline">Make your<br/>FigBadge<br/>your own!</h1>

    <!-- Border -->
    <div class="panel">
      <div class="panel-title">Border</div>
      <div class="border-grid">
        <div class="border-opt active" data-border="none" onclick="setBorder(this)">
          <div class="border-preview">
            <svg class="border-preview-inner" viewBox="0 0 100 100"><rect x="10" y="10" width="80" height="80" rx="8" fill="none" stroke="#ddd" stroke-width="3"/></svg>
          </div>
          <span class="border-label">None</span>
        </div>
        <div class="border-opt" data-border="dashed" onclick="setBorder(this)">
          <div class="border-preview">
            <svg class="border-preview-inner" viewBox="0 0 100 100"><rect x="10" y="10" width="80" height="80" rx="8" fill="none" stroke="#111" stroke-width="4" stroke-dasharray="8 6"/></svg>
          </div>
          <span class="border-label">Dashed</span>
        </div>
        <div class="border-opt" data-border="wiggly" onclick="setBorder(this)">
          <div class="border-preview">
            <svg class="border-preview-inner" viewBox="0 0 100 100">
              <path d="M10,10 Q13,5 16,10 Q19,15 22,10 Q25,5 28,10 Q31,15 34,10 Q37,5 40,10 Q43,15 46,10 Q49,5 52,10 Q55,15 58,10 Q61,5 64,10 Q67,15 70,10 Q73,5 76,10 Q79,15 82,10 Q85,5 88,10 Q91,15 90,10 L90,90 Q91,95 88,90 Q85,85 82,90 Q79,95 76,90 Q73,85 70,90 Q67,95 64,90 Q61,85 58,90 Q55,95 52,90 Q49,85 46,90 Q43,95 40,90 Q37,85 34,90 Q31,95 28,90 Q25,85 22,90 Q19,95 16,90 Q13,85 10,90 Z" fill="none" stroke="#111" stroke-width="3.5"/>
            </svg>
          </div>
          <span class="border-label">Wiggly</span>
        </div>
        <div class="border-opt" data-border="solid" onclick="setBorder(this)">
          <div class="border-preview">
            <svg class="border-preview-inner" viewBox="0 0 100 100"><rect x="10" y="10" width="80" height="80" rx="8" fill="none" stroke="#111" stroke-width="5"/></svg>
          </div>
          <span class="border-label">Solid</span>
        </div>
      </div>
    </div>

    <!-- Cords -->
    <div class="panel">
      <div class="panel-title">Cords</div>
      <div class="cord-grid">
        <div class="cord-opt active" data-cord="black" onclick="setCord(this)">
          <div class="cord-preview">
            <svg class="cord-shape" viewBox="0 0 100 100"><rect x="35" y="0" width="30" height="100" rx="15" fill="#111"/></svg>
          </div>
          <span class="cord-label">Black</span>
        </div>
        <div class="cord-opt" data-cord="periwinkle" onclick="setCord(this)">
          <div class="cord-preview">
            <svg class="cord-shape" viewBox="0 0 100 100"><rect x="35" y="0" width="30" height="100" rx="15" fill="#A89FE7"/></svg>
          </div>
          <span class="cord-label">Periwinkle</span>
        </div>
        <div class="cord-opt" data-cord="blue" onclick="setCord(this)">
          <div class="cord-preview">
            <svg class="cord-shape" viewBox="0 0 100 100"><rect x="35" y="0" width="30" height="100" rx="15" fill="#2D6BE4"/></svg>
          </div>
          <span class="cord-label">Blue</span>
        </div>
      </div>
    </div>
  </div>

  <!-- ── CENTER COLUMN ── -->
  <div class="center-col">

    <!-- Draw -->
    <div class="panel">
      <div class="panel-title">Draw</div>
      <div class="draw-grid">
        <div class="stroke-opt active" data-size="3" onclick="setStroke(this)">
          <div class="stroke-preview">
            <div class="stroke-dot" style="width:6px;height:6px;"></div>
          </div>
          <span class="stroke-label">Small</span>
        </div>
        <div class="stroke-opt" data-size="7" onclick="setStroke(this)">
          <div class="stroke-preview">
            <div class="stroke-dot" style="width:12px;height:12px;"></div>
          </div>
          <span class="stroke-label">Medium</span>
        </div>
        <div class="stroke-opt" data-size="14" onclick="setStroke(this)">
          <div class="stroke-preview">
            <div class="stroke-dot" style="width:20px;height:20px;"></div>
          </div>
          <span class="stroke-label">Large</span>
        </div>
      </div>
    </div>

    <!-- Stickers -->
    <div class="panel-stickers">
      <div class="panel-title">Stickers</div>
      <div class="sticker-grid" id="stickerGrid"></div>
    </div>

    <!-- Background -->
    <div class="panel">
      <div class="panel-title">Background</div>
      <div class="bg-grid">
        <div class="bg-opt active" data-bg="none"     onclick="setBg(this)">
          <div class="bg-preview"><div class="bg-preview-inner pat-none"></div></div>
          <span class="bg-label">None</span>
        </div>
        <div class="bg-opt" data-bg="swag"     onclick="setBg(this)">
          <div class="bg-preview"><div class="bg-preview-inner pat-swag"></div></div>
          <span class="bg-label">Swag</span>
        </div>
        <div class="bg-opt" data-bg="creative" onclick="setBg(this)">
          <div class="bg-preview"><div class="bg-preview-inner pat-creative"></div></div>
          <span class="bg-label">Creative</span>
        </div>
        <div class="bg-opt" data-bg="playful"  onclick="setBg(this)">
          <div class="bg-preview"><div class="bg-preview-inner pat-playful"></div></div>
          <span class="bg-label">Playful</span>
        </div>
      </div>
    </div>

  </div>

  <!-- ── RIGHT COLUMN ── -->
  <div class="right-col">

    <div class="badge-assembly">
      <div class="badge-scale-wrapper" id="badgeScaleWrapper">
        <div class="lanyard-strap" id="lanyardStrap" style="background:#111;">
          <span class="strap-text">FIGMA · FIGBUILD · 2026</span>
        </div>
        <div class="strap-connector"></div>
        <div class="badge-card" id="badgeCard">
          <div class="badge-header">
            <div class="badge-logo-pill">FigBuild</div>
            <div class="badge-year-pill">2026</div>
          </div>
          <svg class="badge-wiggly-border" id="wigglyBorderSvg" style="display:none;" viewBox="0 0 340 480">
            <path fill="none" stroke="#111" stroke-width="4"
              d="M10,10 Q13,5 16,10 Q19,15 22,10 Q25,5 28,10 Q31,15 34,10 Q37,5 40,10 Q43,15 46,10 Q49,5 52,10 Q55,15 58,10 Q61,5 64,10 Q67,15 70,10 Q73,5 76,10 Q79,15 82,10 Q85,5 88,10 Q91,15 94,10 Q97,5 100,10 Q103,15 106,10 Q109,5 112,10 Q115,15 118,10 Q121,5 124,10 Q127,15 130,10 Q133,5 136,10 Q139,15 142,10 Q145,5 148,10 Q151,15 154,10 Q157,5 160,10 Q163,15 166,10 Q169,5 172,10 Q175,15 178,10 Q181,5 184,10 Q187,15 190,10 Q193,5 196,10 Q199,15 202,10 Q205,5 208,10 Q211,15 214,10 Q217,5 220,10 Q223,15 226,10 Q229,5 232,10 Q235,15 238,10 Q241,5 244,10 Q247,15 250,10 Q253,5 256,10 Q259,15 262,10 Q265,5 268,10 Q271,15 274,10 Q277,5 280,10 Q283,15 286,10 Q289,5 292,10 Q295,15 298,10 Q301,5 304,10 Q307,15 310,10 Q313,5 316,10 Q319,15 322,10 Q325,5 328,10 Q331,15 330,10
              L330,470 Q331,475 328,470 Q325,465 322,470 Q319,475 316,470 Q313,465 310,470 Q307,475 304,470 Q301,465 298,470 Q295,475 292,470 Q289,465 286,470 Q283,475 280,470 Q277,465 274,470 Q271,475 268,470 Q265,465 262,470 Q259,475 256,470 Q253,465 250,470 Q247,475 244,470 Q241,465 238,470 Q235,475 232,470 Q229,465 226,470 Q223,475 220,470 Q217,465 214,470 Q211,475 208,470 Q205,465 202,470 Q199,475 196,470 Q193,465 190,470 Q187,475 184,470 Q181,465 178,470 Q175,475 172,470 Q169,465 166,470 Q163,475 160,470 Q157,465 154,470 Q151,475 148,470 Q145,465 142,470 Q139,475 136,470 Q133,465 130,470 Q127,475 124,470 Q121,465 118,470 Q115,475 112,470 Q109,465 106,470 Q103,475 100,470 Q97,465 94,470 Q91,475 88,470 Q85,465 82,470 Q79,475 76,470 Q73,465 70,470 Q67,475 64,470 Q61,465 58,470 Q55,475 52,470 Q49,465 46,470 Q43,475 40,470 Q37,465 34,470 Q31,475 28,470 Q25,465 22,470 Q19,475 16,470 Q13,465 10,470 Z"/>
          </svg>
          <div class="badge-bg-fill" id="badgeBgFill"></div>
          <div id="stickerLayer"></div>
          <canvas id="drawCanvas"></canvas>
        </div>
      </div>
    </div>

    <div class="actions-row">
      <button class="btn-secondary" onclick="undoLast()">Undo</button>
      <button class="btn-secondary" onclick="clearCanvas()">Clear</button>
      <button class="btn-primary"   onclick="doneBadge()">I'm done!</button>
    </div>
  </div>

</div>

<script>
// ─── STATE ───────────────────────────────────────
let drawColor = '#0D0D0D';
let drawSize  = 3;
let isDrawing = false;
let lastX = 0, lastY = 0;
let undoStack = [];
let placingSticker = null;

// ─── CANVAS ──────────────────────────────────────
const canvas = document.getElementById('drawCanvas');
const ctx    = canvas.getContext('2d');
const card   = document.getElementById('badgeCard');

function resizeCanvas() {
  const rect  = card.getBoundingClientRect();
  const saved = undoStack.length ? null : null; // keep undo as-is
  const imgData = canvas.width > 0 ? ctx.getImageData(0, 0, canvas.width, canvas.height) : null;
  canvas.width  = rect.width;
  canvas.height = rect.height;
  if (imgData) ctx.putImageData(imgData, 0, 0);
}

// ─── SCALE BADGE TO FIT RIGHT COLUMN ─────────────
function scaleBadge() {
  const wrapper  = document.getElementById('badgeScaleWrapper');
  const assembly = wrapper.parentElement;
  // Reset transform before measuring
  wrapper.style.transform = 'scale(1)';
  wrapper.style.marginBottom = '0px';

  // A tick later (after repaint) measure & apply scale
  requestAnimationFrame(() => {
    const availH = assembly.clientHeight;
    const availW = assembly.clientWidth;
    const totalH = 90 + 14 + 480; // strap + connector + badge
    const totalW = 340;
    const scale  = Math.min(availH / totalH, availW / totalW, 1);

    wrapper.style.transform       = `scale(${scale})`;
    wrapper.style.transformOrigin = 'top center';
    // Collapse the extra space the un-scaled element would occupy
    wrapper.style.marginBottom = `${-(totalH * (1 - scale))}px`;

    resizeCanvas();
  });
}

window.addEventListener('load', () => {
  scaleBadge();
  renderStickers();
});
window.addEventListener('resize', scaleBadge);

// ─── DRAWING ─────────────────────────────────────
function getPos(e) {
  const rect = canvas.getBoundingClientRect();
  const src  = e.touches ? e.touches[0] : e;
  return {
    x: (src.clientX - rect.left) * (canvas.width  / rect.width),
    y: (src.clientY - rect.top)  * (canvas.height / rect.height)
  };
}

canvas.addEventListener('mousedown',  startDraw);
canvas.addEventListener('mousemove',  draw);
canvas.addEventListener('mouseup',    endDraw);
canvas.addEventListener('mouseleave', endDraw);
canvas.addEventListener('touchstart', e => { e.preventDefault(); startDraw(e); }, { passive:false });
canvas.addEventListener('touchmove',  e => { e.preventDefault(); draw(e); },      { passive:false });
canvas.addEventListener('touchend',   endDraw);

function startDraw(e) {
  if (placingSticker) { placeSticker(e); return; }
  saveUndo();
  isDrawing = true;
  const p = getPos(e);
  lastX = p.x; lastY = p.y;
  ctx.beginPath();
  ctx.arc(lastX, lastY, drawSize / 2, 0, Math.PI * 2);
  ctx.fillStyle = drawColor;
  ctx.fill();
}

function draw(e) {
  if (!isDrawing || placingSticker) return;
  const p = getPos(e);
  ctx.beginPath();
  ctx.moveTo(lastX, lastY);
  ctx.lineTo(p.x, p.y);
  ctx.strokeStyle = drawColor;
  ctx.lineWidth   = drawSize;
  ctx.lineCap = ctx.lineJoin = 'round';
  ctx.stroke();
  lastX = p.x; lastY = p.y;
}

function endDraw() { isDrawing = false; }

// ─── UNDO / CLEAR ────────────────────────────────
function saveUndo() {
  undoStack.push(ctx.getImageData(0, 0, canvas.width, canvas.height));
  if (undoStack.length > 40) undoStack.shift();
}
function undoLast() {
  if (!undoStack.length) return;
  ctx.putImageData(undoStack.pop(), 0, 0);
}
function clearCanvas() {
  saveUndo();
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  document.getElementById('stickerLayer').innerHTML = '';
}

// ─── STROKE SIZE ─────────────────────────────────
function setStroke(el) {
  document.querySelectorAll('.stroke-opt').forEach(e => e.classList.remove('active'));
  el.classList.add('active');
  drawSize = parseInt(el.dataset.size);
}

// ─── BORDER ──────────────────────────────────────
function setBorder(el) {
  document.querySelectorAll('.border-opt').forEach(e => e.classList.remove('active'));
  el.classList.add('active');
  const t = el.dataset.border;
  card.classList.remove('badge-border-dashed','badge-border-solid');
  if (t === 'dashed' || t === 'solid') card.classList.add('badge-border-' + t);
  document.getElementById('wigglyBorderSvg').style.display = t === 'wiggly' ? 'block' : 'none';
}

// ─── CORDS ───────────────────────────────────────
const cordColors = { black:'#111111', periwinkle:'#A89FE7', blue:'#2D6BE4' };
function setCord(el) {
  document.querySelectorAll('.cord-opt').forEach(e => e.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('lanyardStrap').style.background = cordColors[el.dataset.cord];
}

// ─── BACKGROUND ──────────────────────────────────
const bgPatterns = {
  none:     '',
  swag:     'repeating-conic-gradient(#2E8B57 0% 25%,#1E6B3E 0% 50%) 0 0/20px 20px',
  creative: 'repeating-conic-gradient(#FF2D78 0% 25%,#D90057 0% 50%) 0 0/20px 20px',
  playful:  'repeating-conic-gradient(#FFB700 0% 25%,#FF6B00 0% 50%) 0 0/20px 20px',
};
function setBg(el) {
  document.querySelectorAll('.bg-opt').forEach(e => e.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('badgeBgFill').style.background = bgPatterns[el.dataset.bg];
}

// ─── STICKER DATA (4 only) ──────────────────────
const stickerData = [
  { id:'y1', label:'1ST\nYEAR', bg:'#C5B8FF', color:'#3B2D8F' },
  { id:'y2', label:'2ND\nYEAR', bg:'#FF5EC4', color:'#7A0042' },
  { id:'y3', label:'3RD\nYEAR', bg:'#00C27C', color:'#005233' },
  { id:'y4', label:'4TH\nYEAR', bg:'#3D7FFF', color:'#001F5C' },
];

// ─── RENDER STICKER GRID ─────────────────────────
function renderStickers() {
  const grid = document.getElementById('stickerGrid');
  grid.innerHTML = '';
  stickerData.forEach(s => {
    const div = document.createElement('div');
    div.className = 'sticker-item';
    div.dataset.id = s.id;
    div.innerHTML = `<div style="
      width:44px;height:44px;
      background:${s.bg};
      clip-path:polygon(50% 0%,83% 12%,100% 43%,94% 78%,68% 100%,32% 100%,6% 78%,0% 43%,17% 12%);
      display:flex;align-items:center;justify-content:center;
      color:${s.color};font-size:7.5px;font-weight:800;
      text-align:center;line-height:1.3;white-space:pre;padding:5px;
      font-family:'Space Grotesk',sans-serif;letter-spacing:0.04em;
    ">${s.label}</div>`;
    div.addEventListener('click', () => beginPlaceSticker(s, div));
    grid.appendChild(div);
  });
}

// ─── STICKER PLACEMENT ───────────────────────────
function beginPlaceSticker(def, el) {
  if (placingSticker && placingSticker.id === def.id) { cancelPlacing(); return; }
  document.querySelectorAll('.sticker-item').forEach(e => e.classList.remove('selected'));
  el.classList.add('selected');
  placingSticker = def;
  document.body.classList.add('placing-sticker');
}
function cancelPlacing() {
  placingSticker = null;
  document.body.classList.remove('placing-sticker');
  document.querySelectorAll('.sticker-item').forEach(e => e.classList.remove('selected'));
}
function placeSticker(e) {
  if (!placingSticker) return;
  const rect = card.getBoundingClientRect();
  const src  = e.touches ? e.touches[0] : e;
  const x = src.clientX - rect.left;
  const y = src.clientY - rect.top;

  const wrap = document.createElement('div');
  wrap.className = 'canvas-sticker';
  wrap.style.cssText = `left:${x-30}px;top:${y-30}px;width:60px;height:60px;`;
  const s = placingSticker;
  wrap.innerHTML = `
    <div class="sticker-delete" onclick="this.parentElement.remove()">✕</div>
    <div style="width:60px;height:60px;background:${s.bg};
      clip-path:polygon(50% 0%,83% 12%,100% 43%,94% 78%,68% 100%,32% 100%,6% 78%,0% 43%,17% 12%);
      display:flex;align-items:center;justify-content:center;color:${s.color};
      font-size:9px;font-weight:800;text-align:center;line-height:1.3;white-space:pre;
      padding:6px;font-family:'Space Grotesk',sans-serif;letter-spacing:0.04em;
    ">${s.label}</div>`;
  makeDraggable(wrap);
  document.getElementById('stickerLayer').appendChild(wrap);
  cancelPlacing();
}

// ─── DRAG STICKERS ───────────────────────────────
function makeDraggable(el) {
  el.addEventListener('mousedown', e => {
    if (e.target.classList.contains('sticker-delete')) return;
    e.stopPropagation();
    const sx=e.clientX, sy=e.clientY;
    const ol=parseInt(el.style.left)||0, ot=parseInt(el.style.top)||0;
    const onMove = mv => { el.style.left=(ol+mv.clientX-sx)+'px'; el.style.top=(ot+mv.clientY-sy)+'px'; };
    const onUp   = ()  => { document.removeEventListener('mousemove',onMove); document.removeEventListener('mouseup',onUp); };
    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onUp);
  });
}

// ─── DONE ────────────────────────────────────────
function doneBadge() {
  alert('Looking great! Screen 3 (download) coming soon.');
}

document.addEventListener('keydown', e => { if (e.key==='Escape') cancelPlacing(); });
</script>
</body>
</html>